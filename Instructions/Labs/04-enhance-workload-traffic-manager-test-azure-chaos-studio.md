---
lab:
  title: Traffic Manager を使ってワークロードの回復性を高め、Azure Chaos Studio を使って回復性をテストする
  module: Operate with DevOps
---

# ラボ 04 - Traffic Manager を使ってワークロードの回復性を高め、Azure Chaos Studio を使って回復性をテストする

## 推定時間:35 分

## シナリオ

このモジュールのシナリオでは、あなたは小売業界のソフトウェア開発会社で働いており、会社では新しいオンライン ストア アプリケーションで頻繁なダウンタイムとパフォーマンスの問題が発生していることを思い出してください。 あなたは Traffic Manager と Azure Chaos Studio をそれぞれ使用してワークロードを強化し回復性をテストすることを決断したので、このラボでは、Traffic Manager プロファイルを実装して Traffic Manager の機能を検証し、Azure Chaos Studio 環境を構成し、実験を実装して検証する機会を提供します。

## 目標

このラボでは、次のことを行います。

- ラボ用の Azure サブスクリプションを準備する
- Traffic Manager を使用してワークロードの回復性を強化する
- Azure Chaos Studio を使用してワークロードの回復性をテストする
- ラボで使用されたリソースを削除する

> **注:**  前のラボでは、.NET Web アプリの 2 つのインスタンスを 2 つの Azure リージョンにデプロイしました。 このラボでは、まず、この 2 つの Web アプリ インスタンス間で Azure Traffic Manager の負荷分散機能を実装する回復性がある構成を作成します。 次に、Azure Chaos Studio を使っていずれかのアプリの障害をトリガーし、負荷分散実装の回復性をテストします。

> **注:**  このラボでは、以前のすべてのラボで使用していたのと同じ GitHub アカウントを使用してください。

## 前提条件

- 「[ラボ 01 - GitHub を使用したアジャイルの計画管理](01-agile-planning-management-using-github.md)」を完了していること
- 「[ラボ 02 - GitHub で作業フローを実装する](02-implement-manage-repositories-using-github.md)」を完了していること
- 「[ラボ 03 - GitHub Actions を使って CI/CD を実装し、Bicep を使って IaC を実装する](03-implement-ci-cd-with-github-actions-and-iac-with-bicep.md)」を完了していること
- 所有者レベルのアクセス権を持っている Azure サブスクリプション

## 演習 0: ラボ用の Azure サブスクリプションを準備する

> **注:**  新しい Azure サブスクリプションを使用している場合、一部の Azure リソース プロバイダーが登録されていない可能性があります。 登録プロセスには数分かかる場合があるため、待機時間を最小限に抑えるために、このラボの初めに登録します。

> **注:**  このラボでは、Azure Chaos Studio を使用します。 お使いのサブスクリプションで Azure Chaos Studio を初めて実装する場合は、最初に対応するリソース プロバイダーを登録する必要があります。

1. Web ブラウザーを開始し、Azure portal (`https://portal.azure.com`) にアクセスします。
1. メッセージが表示されたら、前のラボで使用した Azure サブスクリプションへの所有者アクセス権を持つ Microsoft Entra ID アカウントを使ってサインインします。
1. Azure portal が表示されている Web ブラウザー タブで、ページ上部の検索テキスト ボックスに「**サブスクリプション**」と入力し、結果の一覧で **[サブスクリプション]** を選択します。
1. [サブスクリプション] ページの左側にある垂直メニューで、**[リソース プロバイダー]** を選びます。
1. リソース プロバイダーの一覧で、**Microsoft.Chaos** を検索して選択します。
1. **Microsoft.Chaos** リソース プロバイダーが選択されている状態で、ツール バーの **[登録]** を選びます。

   > **注:**  登録が完了するまで待つ必要はありません。次の演習に直接進んでください。 登録には数分かかる場合があります。

## 演習 1: Traffic Manager を使用してワークロードの回復性を強化する

この演習では、Azure Traffic Manager を使って、2 つの異なる Azure リージョンにある .NET Web アプリの 2 つのインスタンスに要求を分散する、回復性に優れた構成を実装します。

> **注:**  ラボの目的のために、ここでは米国東部リージョンにある .NET ベースの Web アプリ eShopOnWeb のデプロイをプライマリ インスタンスと考えます。 今回このように考えるのは完全に恣意的 (かつデモンストレーションだけが目的) ですが、いずれかのエンドポイントを優先すると有益なシナリオも存在する可能性があります。

演習は次のタスクで構成されます。

- タスク 1:Traffic Manager プロファイルを実装する
- タスク 2:Traffic Manager の機能を確認する

### タスク 1:Traffic Manager プロファイルを実装する

1. Azure portal が表示されている Web ブラウザー タブで、ページ上部の検索テキスト ボックスに「**Traffic Manager プロファイル**」と入力し、結果の一覧から **[Traffic Manager プロファイル]** を選びます。
1. **[負荷分散 \| Traffic Manager]** ページで、**[+ 作成]** を選びます。
1. **[Traffic Manager プロファイルの作成]** ページで、次の操作を実行します。

   - **[名前]** テキスト ボックスに、「**devopsfoundationstmprofile**」と入力します。

       > **注:**  Traffic Manager プロファイルの名前はグローバルに一意である必要があります。 名前が既に使用されているというエラー メッセージが表示される場合は、別の名前をお試しください。名前は必ず記録しておいてください。 このラボ全体で必要になります。

   - **[ルーティング方法]** ドロップダウン リストで **[優先度]** を選択します。

   > **注:**  優先度によるルーティング方法を選ぶのは、すべての要求を米国東部にある Azure App Service Web アプリで処理する必要があるという、やや恣意的な仮定を反映するためです。

   - 使用する Azure サブスクリプションが **[サブスクリプション]** ドロップダウン リストに表示されることを確認します
   - **[リソース グループ]** ドロップダウン リストの下にある **[新規作成]** リンクを選択し、**[名前]** テキスト ボックスに「**devops-foundations-rg**」と入力して、**[OK]** を選びます。
   - **[リソース グループの場所]** ドロップダウン リストで、このコースの前のラボで選択したのと同じ Azure リージョンを選択します。

1. **[作成]** を選択して、プロビジョニング プロセスを開始します。

   > **注**: デプロイが完了するまで待ちます。 これは 1 分以内に完了するはずです。

1. **[負荷分散 \| Traffic Manager]** ページで、必要に応じて **[最新の情報に更新]** を選択してから、**[devopsfoundationstmprofile]** を選択します。
1. **[devopsfoundationstmprofile]** ページの **[要点]** セクションで、**[DNS 名]** 設定の値をコピーして記録しておきます。 このラボ全体で必要になります。
1. **[devopsfoundationstmprofile]** ページの左ナビゲーション メニューにある **[設定]** セクションで、**[構成]** を選択します。
1. **[devopsfoundationstmprofile \| 構成]** ページの内容を確認します。 既定では、**[DNS の有効期限 (TTL)]** が **60** 秒に設定されていることに注意してください。 この値を **5** 秒に変更します。

   > **注:**  TTL の値を小さくすると、フェールオーバー時間が短縮されます。 

   > **注:**  TTL の値に加えて、プローブ間隔、プローブのタイムアウト、許容される障害数も、エンドポイントの障害が検出される時間に影響します。

1. **[devopsfoundationstmprofile \| 構成]** ページの **[プロトコル]** ドロップダウン リストで **[HTTPS]** を選択し、**[ポート]** テキスト ボックスに「**443**」と入力します。

   > **注:**  エンドポイントとして構成する両方の Azure App Service Web アプリには、HTTPS 経由で既定の TCP ポート 443 でアクセスできます。

1. **[devopsfoundationstmprofile \| 構成]** ページで、**[保存]** を選択します。
1. **[devopsfoundationstmprofile]** ページの左ナビゲーション メニューにある **[設定]** セクションで、**[エンドポイント]** を選択します。
1. **[devopsfoundationstmprofile \| エンドポイント]**** ページで、**[+ 追加]** を選択します。

   > **注:**  最初に、Azure App Service Web アプリを表すエンドポイントを追加します。

1. **[エンドポイントの追加]** ペインで、次の操作を実行します。

   - **[種類]** ドロップダウン リストで **[Azure エンドポイント]** が表示されることを確認します。
   - **[名前]** テキスト ボックスに「**DevOps の基礎 Web アプリ - 米国東部**」と入力します。
   - **[Enable Endpoint] (エンドポイントの有効化)** チェックボックスがオンになっていることを確認します。
   - **[ターゲット リソースの種類]** ドロップダウン リストで、**[App Service]** を選択します。
   - **[ターゲット リソース]** ドロップダウン リストの **[rg-eshoponweb-eastus]** セクションで、米国東部 Azure リージョンの App Service Web アプリの名前を選択します。
   - **[優先度]** テキスト ボックスに「**1**」と入力します。

   > **注:**  優先度の値が小さいほど、優先順位が高くなります。 今回は、すべての要求が米国東部リージョンの Web アプリ インスタンスに送信されます (そのインスタンスが使用可能な状態である限り)。

   - **[正常性チェック]** が有効になっていることを確認します。

1. **[追加]** を選択します。

1. **[devopsfoundationstmprofile \| エンドポイント]**** ページに戻り、**[+ 追加]** を選択します。

   > **注:**  次に、西ヨーロッパの Azure リージョンにデプロイしたもう 1 つの Azure App Service Web アプリを表すエンドポイントを追加します。

1. **[エンドポイントの追加]** ペインで、次の操作を実行します。

   - **[種類]** ドロップダウン リストで **[Azure エンドポイント]** が表示されることを確認します。
   - **[名前]** テキスト ボックスに「**DevOps の基礎 Web アプリ - 西ヨーロッパ**」と入力します。
   - **[Enable Endpoint] (エンドポイントの有効化)** チェックボックスがオンになっていることを確認します。
   - **[ターゲット リソースの種類]** ドロップダウン リストで、**[App Service]** を選択します。
   - **[ターゲット リソース]** ドロップダウン リストの **[rg-eshoponweb-westeurope]** セクションで、西ヨーロッパ Azure リージョンの App Service Web アプリの名前を選択します。
   - **[優先度]** テキスト ボックスに「**2**」と入力します。
   - **[正常性チェック]** が有効になっていることを確認します。

1. **[追加]** を選択します。
1. **[devopsfoundationstmprofile \| エンドポイント]**** ページに戻り、両方のエンドポイントが、**[モニターの状態]** 列が **[オンライン]** エントリになって表示されていることを確認します。

   > **注:**  状態エントリを最新の状態にするために、数分待ってから **[最新の情報に更新]** を選択する必要がある場合があります。

### タスク 2:Traffic Manager の機能を確認する

1. Web ブラウザー ウィンドウを起動し、Traffic Manager プロファイルに関連付けられている DNS 名に移動します。
1. 前のラボでデプロイした Azure App Service Web アプリによってホストされる Web サイトの見慣れたページが Web ブラウザーに表示されることを確認します。
1. 新しく開いた Web ブラウザー ウィンドウを閉じます。
1. Azure portal が表示されている Web ブラウザー ウィンドウに切り替えます。
1. Azure portal で、検索テキスト ボックスの右にある **[Azure Cloud Shell]** アイコンを選択します。
1. 必要に応じて、[Cloud Shell] ペインの左上隅にあるドロップダウン メニューで **[Bash]** を選びます。
1. [Cloud Shell] ペイン内の Bash セッションで次のコマンドを実行して、前のタスクで作成した Traffic Manager プロファイルの DNS 名を、対応する 2 つのエンドポイントのいずれかに解決します (プレースホルダー `<tm_profile>` は Traffic Manager プロファイルの DNS 名に置き換えてください。例: `devopsfoundationstmprofile.trafficmanager.net`)。ただし、先頭の `https:\\` は削除してください。

   ```cli
   nslookup <tm_profile>
   ```

1. 同じコマンドを数回再実行します。5 秒以上間を空けてから各呼び出しを行ってください (DNS キャッシュの可能性を排除するため)。各呼び出しの出力で、米国東部 Azure リージョンにある Web アプリの DNS 名が参照されていることに注意してください。

## 演習 2: Azure Chaos Studio を使用してワークロードの回復性をテストする

この演習では、Azure Chaos Studio を使ってワークロードの回復性をテストします。

> **注:**  この演習では、Azure Chaos Studio の使用方法を示します。 Azure Chaos Studio の目的は、アプリケーションとサービスの回復性の測定、理解、構築を支援することです。 それを実現するために、回復性のギャップを特定し、対応する軽減策を事後対応的ではなく予防的に実装するために、ワークロードを意図的に中断させます。

演習は次のタスクで構成されます。

- タスク 1:Azure Chaos Studio 環境を構成する
- タスク 2:実験を実装する
- タスク 3:実験を検証する

### タスク 1:Azure Chaos Studio 環境を構成する

1. Azure portal が表示されている Web ブラウザー タブで、ページ上部の検索テキスト ボックスに「**Chaos Studio**」と入力し、結果の一覧から **[Chaos Studio]** を選びます。
1. **[Chaos Studio]** ページで、**[ターゲット]** を選択します。
1. **[Chaos Studio \| ターゲット]** ページで、前のラボでデプロイした、米国東部リージョンの **rg-eshoponweb-eastus** リソース グループにある Azure App Service Web アプリ インスタンスを選択します。
1. ツール バーで、**[Enable targets] (ターゲットを有効にする)** ドロップダウン リストのヘッダーを選択し、ドロップダウン リストから **[サービス直接ターゲット (すべてのリソース) を有効にする]** を選択します。
1. **[Enable service direct targets] (サービス直接ターゲットを有効にする)** ページで、適切な App Service Web アプリ インスタンスが表示されていることを確認し、**[確認と有効化]** を選択して、**[有効化]** を選択します。

   > **注:**  ターゲットが有効になるまで待ちます。 これに要する時間は 1 分未満です。

### タスク 2:実験を実装する

1. Azure portal で、ページ上部の検索テキスト ボックスに「**Chaos Studio**」と入力し、結果の一覧から **[Chaos Studio]** を選びます。
1. **[Chaos Studio]** ページで、**[実験]** を選択します。
1. **[実験]** ページで、**[+ 作成]** を選択してから、ドロップダウン リストで **[新しい実験]** を選択します。
1. **[Create an experiment] (実験を作成する)** ページの **[基本]** タブで、次の操作を実行します。

   - 使用する Azure サブスクリプションが **[サブスクリプション]** ドロップダウン リストに表示されることを確認します。
   - **[リソース グループ]** ドロップダウン リストの下にある **[新規作成]** リンクを選択し、**[名前]** テキスト ボックスに「**devops-foundations-rg**」と入力して、**[OK]** を選びます。
   - **[Experiment details] (実験の詳細)** セクションの **[名前]** テキスト ボックスに、「**DevOps_Foundations_Labs_Experiment_01**」と入力します。
   - **[リージョン]** ドロップダウン リストで、**[西ヨーロッパ]** Azure リージョンを選択します。

   > **注:**  任意の Azure リージョンを選択することもできますが、西ヨーロッパ リージョンにあるリソースの障害をテストすることを考慮すると、米国東部以外のリージョンの方が適しているでしょう。

1. **[Create an experiment] (実験を作成する)** ページの **[基本]** タブで、**[次へ: アクセス許可 >]** を選択します。
1. **[アクセス許可]** タブで、既定のオプション **[System assigned identity] (システム割り当て ID)** をそのまま使用して、**[Next: Experiment designer >] (次へ: 実験デザイナー >)** を選択します。
1. **[Experiment designer] (実験デザイナー)** タブで、次の操作を実行します。

   - **[ステップ]** テキスト ボックスに、「**ステップ 1: App Service Web アプリのフェールオーバー**」と入力します。
   - **[ブランチ]** テキスト ボックスに、「**ブランチ 1: App Service 障害のエミュレート**」と入力します。
   - **[+ アクションの追加]** を選択し、ドロップダウン リストで **[障害の追加]** を選択します。

1. **[障害の追加]** ペインの **[Fault details] (障害の詳細)** タブで、**[障害]** ドロップダウン リストから **[Stop App Service] (App Service の停止)** を選択し、**[期間 (分)]** の値を 10 に設定します。
1. **[障害の追加]** ペインの **[Fault details] (障害の詳細)** タブで、**[次へ: ターゲット リソース >]** を選択します。
1. **[障害の追加]** ペインの **[ターゲット リソース]** タブで、**[Manually select from a list] (リストから手動で選択)** オプションが選択されていることを確認し、Chaos Studio 環境にターゲットとして追加した App Service Web アプリを選んでから、**[追加]** を選択します。
1. **[Create an experiment] (実験を作成する)** ページの **[Experiment designer] (実験デザイナー)** タブに戻り、**[確認および作成]** を選択します。
1. **[Create an experiment] (実験を作成する)** ページの **[確認および作成]** タブで、**[作成]** を選択します。

   > **注:**  実験が作成されるまで待ちます。 これに要する時間は 1 分未満です。

   > **注:**  実験を成功させるためには、新しく作成した管理サービス アカウントに、Azure App Service Web アプリを停止できるアクセス許可を付与する必要もあります。 この目的のために、ここでは組み込みの Azure 共同作成者ロールを利用しますが、最小限の特権の原則に従いたい場合はカスタム ロールを作成することもできます。

1. Azure portal で、ページ上部の検索テキスト ボックスに「**App Services**」と入力し、結果の一覧で **[App Services]** を選びます。
1. **[App Services]** ページで、前のラボでデプロイした米国東部リージョンにある Azure App Service Web アプリを選択します。
1. Web アプリのページで、左側の垂直メニューから **[アクセスの制御 (IAM)]** を選択します。
1. Web アプリの **[アクセスの制御 (IAM)]** ページで、**[+ 追加]** を選択し、ドロップダウン リストで **[ロールの割り当てを追加]** を選択します。
1. **[ロールの割り当てを追加]** ページの **[ロール]** タブで、**[特権管理者ロール]** を選択し、ロールの一覧から **[共同作成者]** を選択して、**[次へ]** を選択します。
1. **[ロールの割り当てを追加]** ページの **[メンバー]** タブで、**[Assigned access to] (アクセスの割り当て先)** オプションを **[マネージド ID]** に設定し、**[+ メンバーを選択する]** を選びます
1. **[マネージド ID の選択]** ペインの **[マネージド ID]** ドロップダウン リストで **[Chaos Experiment] (カオス実験)** を選択し、マネージド ID の一覧からこのタスクで先ほど作成した ID を選択して、**[選択]** を選びます。
1. **[ロールの割り当ての追加]** ページの **[メンバー]** タブに戻り、**[確認と割り当て]** を選択してから、もう一度 **[確認と割り当て]** を選択します。

### タスク 3:実験を検証する

1. Azure portal で、**[Chaos Studio]** ページに戻り、左側の垂直メニューで **[実験]** を選択します。
1. 実験の一覧で、**[DevOps_Foundations_Labs_Experiment_01]** を選択します。
1. **[DevOps_Foundations_Labs_Experiment_01]** ページで **[開始]** を選択し、確認を求められたら **[OK]** を選択します。
1. 実験の状態が **[実行中]** に変わるまで待ちます。
1. **[DevOps_Foundations_Labs_Experiment_01]** ページの **[履歴]** セクションで、現在の実験の実行を表すエントリの **[詳細]** リンクを選択します。
1. **[DevOps_Foundations_Labs_Experiment_01]** 実験の詳細ページで、実験に関連付けられているステップ、ブランチ、アクションを含む一覧を確認します。

   > **注:**  場合によっては、**[最新の情報に更新]** ツール バー エントリを選択して一覧の状態を更新する必要があります。

1. **[アクション]** エントリを選択して、**[Fault details] (障害の詳細)]** ペインを表示します。
1. **[Running targets] (実行中のターゲット)** セクションで、Azure App Service Web アプリを表すエントリを選択します。
1. Web アプリ ページの **[要点]** セクションで、Web アプリの状態が **[停止]** と表示されていることに注意してください。

   > **注:**  場合によっては、**[最新の情報に更新]** ツール バー エントリを選択して Web アプリの状態を更新する必要があります。

   > **注:**  次に、Traffic Manager が、そのプロファイルを対象とする要求を西ヨーロッパ リージョンの App Service Web アプリを表すエンドポイントに正常にリダイレクトしているかどうかを確認します。

1. Web ブラウザーを起動し、Traffic Manager プロファイルに関連付けられている DNS 名に移動します。
1. 前のラボでデプロイした Azure App Service Web アプリによってホストされる Web サイトの見慣れたページが Web ブラウザーに表示されることを確認します。
1. Azure portal が表示されている Web ブラウザー ウィンドウに切り替えます。
1. Azure portal で、検索テキスト ボックスの右にある **[Azure Cloud Shell]** アイコンを選択します。
1. [Cloud Shell] ペイン内の Bash セッションで次のコマンドを実行して、前の演習で作成した Traffic Manager プロファイルの DNS 名を、対応する 2 つのエンドポイントのいずれかに解決します (プレースホルダー `<tm_profile>` は Traffic Manager プロファイルの DNS 名に置き換えてください。ただし、先頭の `https:\\` は削除してください)。

   ```cli
   nslookup <tm_profile>
   ```

1. 同じコマンドを数回再実行します。5 秒以上間を空けてから各呼び出しを行ってください (DNS キャッシュの可能性を排除するため)。各呼び出しの出力で、西ヨーロッパ Azure リージョンにある Web アプリの DNS 名が参照されていることを確認してください。

> **注:**  この例はあまりにも単純に見えるかもしれませんが、この演習の第一の目的は、Azure Chaos Studio ベースのテストとその主なコンポーネントを実装するプロセスを説明することでした。 Azure App Service Web アプリがより複雑な環境の一部であり、その障害の影響を予測するのがはるかに困難な場合も、同等のアプローチを使用できます。

### 演習 3:ラボで使用されたリソースを削除する

この演習では、ラボで使用したリソースを削除します。

1. Azure portal が表示されている Web ブラウザー タブで、ページ上部の検索テキスト ボックスに「**リソース グループ**」と入力し、結果の一覧で **[リソース グループ]** を選びます。
1. **[リソース グループ]** ページで、リソース グループの一覧から、現在のラボで作成したリソース グループを選択します。
1. [リソース グループ] ページで、**[リソース グループの削除]** を選択します。
1. **[削除を確認するために、リソース グループ名を入力してください]** テキスト ボックスに削除するリソース グループの名前を入力し、**[削除]** を選びます。

   > **注:**  リソース グループが削除されるのを待ちます。 これに要する時間は 1 分未満です。

1. このコースの前のラボで作成したリソース グループに対しても、前の手順を繰り返します。

    > **注:**  リソース グループを削除すると、Traffic Manager プロファイルや Azure Chaos Studio 環境など、それに関連付けられているすべてのリソースが削除されます。

    > **注:**  このコースの前のラボで作成した GitHub アカウントとリポジトリを削除する必要はありません。 これらは、作業のポートフォリオとして引き続き使用できます。
